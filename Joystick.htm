<html>
  <head>
    <script type="text/javascript">
      var host = "ws://127.0.0.1:8765/",
          ws = new WebSocket(host),
          invert_x =  1,
          invert_y = -1,
          invert_z = -1,
          killCode = 0,
          key_x = 0,
          key_y = 0;
          key_trigger = 0;

      ws.onclose = function(event){ console.log(event); }
      
      function keyDownListen(key){
        console.log(key.key);
        switch( key.key ){
        case "ArrowUp":
          key_y = 1;
          break;
        case "ArrowDown":
          key_y = -1;
          break;
        case "ArrowRight":
          key_x = 1;
          break;
        case "ArrowLeft":
          key_x = -1;
          break;
        case " ":
          key_trigger = 1;
          break;
        }
      }

      function keyUpListen(key){
        switch( key.key ){
        case "ArrowUp":
          key_y = 0;
          break;
        case "ArrowDown":
          key_y = 0;
          break;
        case "ArrowRight":
          key_x = 0;
          break;
        case "ArrowLeft":
          key_x = 0;
          break;
        case " ":
          key_trigger = 0;
          break;
        }
      }
      function updateStick(){
        var x=0, y=0, z=0, trigger = 0;
        try{
          var gamepads = navigator.getGamepads(); 
          x = gamepads[1]["axes"][0]*invert_x;
          y = gamepads[1]["axes"][1]*invert_y;
          z = gamepads[1]["axes"][2]*invert_z;
          trigger = gamepads[1]["buttons"][0]["pressed"];
        }
        catch{ }
        if(  key_x != 0 ){ x = key_x; }
        if(  key_y != 0 ){ y = key_y; }
        if(  key_trigger != 0 ){ trigger = key_trigger; }
        return [x,y,z,trigger];
      }
      
      function drawScreen(){
          var cursor_color="#00ff00";
          var [x,y,z,trigger] = updateStick();
//          if(ws.readystate!=1){ ws = new WebSocket(host); }
          if(ws.readyState==1){ ws.send(x+","+y+","+z+","+trigger); }
          document.getElementById("xy_axis").style.left=x*250+250;
          document.getElementById("xy_axis").style.bottom=y*250+250;
          document.getElementById("z_axis").style.height=z*150+150;
          if(trigger){ cursor_color="#FF0000"; }
          document.getElementById("xy_axis").style.backgroundColor=cursor_color;
      }

      function listGamepads(){
        var gamepads=navigator.getGamepads();
        for(i=0;i<gamepads.length;i++){ 
          if(gamepads[i]!=null){
            console.log( gamepads[i]);
            document.forms[0].elements["Joystick"].add(new Option(gamepads[i]["id"],i));
          }
        }
      }
      function pageInit(){
        setTimeout(listGamepads,500);
        killCode = setInterval(drawScreen, 50);
      } 

      document.onkeydown = keyDownListen; 
      document.onkeyup = keyUpListen; 
    </script>
  </head>
  <body onLoad="pageInit()">
    <div style="position:relative;">
      <div style="position: absolute;height:300px;width:30px;background-color: #000000;vertical-align: bottom;">
          <div id="z_axis" style="
            bottom: 0;
            position: absolute;
            height: 20;
            width: 20px;
            background-color: #00ff00;
            margin-left: 5px;
            margin-right: 5px;
            vertical-align: bottom; ">
          </div>
      </div>
      <div style="position:relative; left:50; top:0; height:500px;width:500px;background-color: #000000; ">
        <div id="xy_axis" style="position:absolute; bottom:250; left:250; height:20; width:20; background-color:#00ff00">
        </div>
      </div>
    </div>
    <div>
      <form>
        <select id="joystick" name="Joystick">
        </select>
      </form>
    </div>
  </body>
</html>
